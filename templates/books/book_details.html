{% extends "base.html" %}
{% load crispy_forms_tags %}


{% block main_content %}
    
    <link rel="stylesheet" type="text/css" href="https://bootswatch.com/5/journal/bootstrap.min.css">
    
    <br>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <h1 class="text-center">{{ book.title}}</h1>

                {% csrf_token %}
                <form method="get" action="{% url "book details" pk=book.pk %}">
                    
                    <img src="{{ book.cover_image }}" alt="Cover Image">
                <br>
             
                    <ul type="none">
                        
                        <li class="align-left descname"><h4 class="data-decor">By: {{ book.author }}</h4></li>
               
                        <li><h4>Published in: {{ book.year_published }}</h4></li>
                        <li><h4>
                            {% if book.category.all|length == 1 %}
                            Category: {{ book.category.name }}
                            {% else %}
                            Categories:
                                {% for category in book.categories.all %}
                                {{ category.name }}
                                    {% if not forloop.last %}
                                        / 
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </h4>
                        </li>
                        <li class="description"><h4>Summary: {{ book.description }}</h4></li>
                        <li><h6 class="grey">Added by: {% if not book.added_by %}Anonymous
                        {% else %}<a href="{% url 'bookie profile' pk=book.added_by.pk %}">{{ book.added_by }}</a>
                        {% endif %}</h6></li>

                        <h4 class="container">Overall rating: {{ book.overall_rating|floatformat:1 }}</h4>
                        
                    </ul>                
                
                </form>

            {# WORKING WITH THE LIBRARIES WANT_TO_READ AND HAVE_READ AND LATER WITH THE REVIEWS FUNCTIONS #}

            {# if the user isnt` auth we redirect him to the login page #}
            {% if not current_user.is_authenticated %}
                <h2>You have to be logged in to share your thoughts on the book.</h2>
                <form method="post" action="{% url 'login bookie' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                    Log-in/Create your own account here!
                </button>
                </form>

             {# here we work with the auth users only ad their libraries #}

            {% else %}
                {% if book in current_user.profile.have_read.all %}
                    {# We go to the reviews #}
                    
                    {% if not current_review.has_voted %}
                         <form action="{% url 'submit review' book_id=book.pk %}" method="post" onsubmit="validateForm();">
                            {% csrf_token %}

                            <h5>Rate the book:</h5>

                            <div class="rate">
                                <input type="radio" name='rating' id="rating10" value="10">
                                <label for="rating10" title="One of my favourite books!"></label>

                                <input type="radio" name='rating' id="rating9" value="9">
                                <label for="rating9" class="half" title="I hope Netflix doesn`t make an adaptation."></label>

                                <input type="radio" name='rating' id="rating8" value="8">
                                <label for="rating8" title="Highly engaging."></label>

                                <input type="radio" name='rating' id="rating7" value="7">
                                <label for="rating7" title="Worth a read!" class="half"></label>

                                <input type="radio" name='rating' id="rating6" value="6">
                                <label for="rating6" title="Good read."></label>

                                <input type="radio" name='rating' id="rating5" value="5">
                                <label for="rating5" title="It was okay." class="half"></label>

                                <input type="radio" name='rating' id="rating4" value="4">
                                <label for="rating4" title="Expected a bit more."></label>

                                <input type="radio" name='rating' id="rating3" value="3">
                                <label for="rating3" title="Not my cup of tea" class="half"></label>

                                <input type="radio" name='rating' id="rating2" value="2">
                                <label for="rating2" title="Netflix would have done better."></label>

                                <input type="radio" name='rating' id="rating1" value="1">
                                <label for="rating1" title="Disappointing!" class="half"></label>

                            </div>

                            <h5>Share your opinion on this  book.</h5>
                                <div>
                                    <textarea name="review" rows="4" class="form-control"></textarea>
                                    <input type="submit" value="Submit" class="btn btn-primary">


                                </div>
                         </form>
                        
                        
                    {% else %}
                    {# he can only edit/delete his review #}
                        <h4>Your rating of this book: {{ current_review.rating }}</h4>
                        <h4>Your review of this book:</h4>
                        <textarea>{{ current_review.review }}</textarea>
                      
                        
                        {# delete button #}
                        <form method="post" action="{% url 'delete review' current_review.pk %}">
                            {% csrf_token %}

                            <button type="submit" class="btn btn-primary" onclick="return confirmReviewDelete();"
                            >Delete your review and rating</button>
                            </form>
                        
                    {% endif %}

                {% elif book in current_user.profile.want_to_read.all %}
                    <h1>It`s in the want to read</h1>
                    {# he can add it to the have_read library #}
                            <div class="col-md-6">
                             <form action="{% url 'add to already read' %}" method="post">
                                {% csrf_token %}

                                <input type="hidden" name="book_id" value="{{ book.pk }}">
                                <button class="btn btn-primary" type="submit">I have read this book</button>
                            </form>
                            </div>
                        </div>
                    </div>


                {# In case the user hasn`t added the book in any of his libraries #}
                {% else %}
                    <h1>It isn`t anywhere</h1>
                    {# he ca add to want_to_read library #}
                    <div class="container">
                        <div class="row">
                            <div class="col-md-6">

                                {# add it to want_to_read library #}
                                <form action="{% url 'add to wishlist' %}" method="post">
                                {% csrf_token %}

                                <input type="hidden" name="book_id" value="{{ book.pk }}">
                                <button class="btn btn-secondary" type="submit">I want to read this book</button>
                                </form>
                            </div>

                            {# he can add it to the have_read library #}
                            <div class="col-md-6">
                             <form action="{% url 'add to already read' %}" method="post">
                                {% csrf_token %}

                                <input type="hidden" name="book_id" value="{{ book.pk }}">
                                <button class="btn btn-primary" type="submit">I have read this book</button>
                            </form>
                            </div>
                        </div>
                    </div>


                {% endif %}

            {% endif %}






            
            {# CRUD OPERATIONS ONLY FOR SUPERUSER AND THE ONE, WHO ADDED THE BOOK #}
                <br>
                <br>
                {% if request.user.is_superuser or book.added_by == request.user %}
                    <a class="btn btn-primary container row justify-content-center" href="{% url 'update book' pk=book.pk %}">Edit Book</a>

                    <form method="post" action="{% url 'delete book' pk=object.pk %}">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirmBookDelete();"
                    class="btn container row">Delete Book</button>
                    </form>

                {% endif %}
            

            </div>
        </div>
    </div>

    <script>
    function confirmBookDelete(){
        return confirm("Are you sure you want to delete this book?")
        
    }
    
    function confirmReviewDelete(){
        return confirm("This action will delete both your review and rating.")
        
    }
    
   
    function validateForm() {
        var review = document.getElementById("id_review").value;
        var rating = document.querySelector('input[name="rating"]:checked');

        if (review.trim() === "") {
            alert("Please enter your review.");
            return false;
        }

        if (!rating) {
            alert("Please select a rating.");
            return false;
        }

        return true;
    }

    
    </script>
    
    

{% endblock %}
